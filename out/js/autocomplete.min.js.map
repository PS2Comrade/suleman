{"version":3,"file":"autocomplete.min.js","names":["res: Response","timeoutId: number","autocomplete: HTMLElement | null","autocompleteList: HTMLUListElement | null"],"sources":["../../../../../client/simple/src/js/main/autocomplete.ts"],"sourcesContent":["// SPDX-License-Identifier: AGPL-3.0-or-later\n\nimport { assertElement, http, listen, settings } from \"../core/toolkit.ts\";\n\nlet latestRequestSeq = 0;\nlet lastRenderedSeq = 0;\n\nconst fetchResults = async (qInput: HTMLInputElement, query: string, requestSeq: number): Promise<void> => {\n  try {\n    let res: Response;\n\n    if (settings.method === \"GET\") {\n      res = await http(\"GET\", `./autocompleter?q=${encodeURIComponent(query)}`);\n    } else {\n      res = await http(\"POST\", \"./autocompleter\", { body: new URLSearchParams({ q: query }) });\n    }\n\n    const results = await res.json();\n\n    // Render only if this response is newer than what is currently rendered\n    if (requestSeq <= lastRenderedSeq) {\n      return;\n    }\n\n    const autocomplete = document.querySelector<HTMLElement>(\".autocomplete\");\n    if (!autocomplete) {\n      return;\n    }\n\n    const autocompleteList = document.querySelector<HTMLUListElement>(\".autocomplete ul\");\n    if (!autocompleteList) {\n      return;\n    }\n\n    autocomplete.classList.add(\"open\");\n    autocompleteList.replaceChildren();\n\n    // show an error message that no result was found\n    if (results?.[1]?.length === 0) {\n      const noItemFoundMessage = Object.assign(document.createElement(\"li\"), {\n        className: \"no-item-found\",\n        textContent: settings.translations?.no_item_found ?? \"No results found\"\n      });\n      autocompleteList.append(noItemFoundMessage);\n      lastRenderedSeq = requestSeq;\n      return;\n    }\n\n    const fragment = new DocumentFragment();\n\n    for (const result of results[1] ?? []) {\n      const li = Object.assign(document.createElement(\"li\"), { textContent: result });\n\n      listen(\"mousedown\", li, () => {\n        qInput.value = result;\n\n        const form = document.querySelector<HTMLFormElement>(\"#search\");\n        form?.submit();\n\n        autocomplete.classList.remove(\"open\");\n      });\n\n      fragment.append(li);\n    }\n\n    autocompleteList.append(fragment);\n    lastRenderedSeq = requestSeq;\n  } catch (error) {\n    console.error(\"Error fetching autocomplete results:\", error);\n  }\n};\n\nconst qInputEl = document.getElementById(\"q\") as HTMLInputElement | null;\n\nlet timeoutId: number;\n\nif (qInputEl) {\n  listen(\"input\", qInputEl, () => {\n    clearTimeout(timeoutId);\n\n    const query = qInputEl.value;\n    const minLength = settings.autocomplete_min ?? 2;\n\n    if (query.length < minLength) return;\n\n    timeoutId = window.setTimeout(async () => {\n      if (query === qInputEl.value) {\n        const seq = ++latestRequestSeq;\n        await fetchResults(qInputEl, query, seq);\n      }\n    }, 0);\n  });\n}\n\nconst autocomplete: HTMLElement | null = document.querySelector<HTMLElement>(\".autocomplete\");\nconst autocompleteList: HTMLUListElement | null = document.querySelector<HTMLUListElement>(\".autocomplete ul\");\nif (autocompleteList && qInputEl) {\n  listen(\"keyup\", qInputEl, (event: KeyboardEvent) => {\n    const listItems = [...autocompleteList.children] as HTMLElement[];\n\n    const currentIndex = listItems.findIndex((item) => item.classList.contains(\"active\"));\n    let newCurrentIndex = -1;\n\n    switch (event.key) {\n      case \"ArrowUp\": {\n        const currentItem = listItems[currentIndex];\n        if (currentItem && currentIndex >= 0) {\n          currentItem.classList.remove(\"active\");\n        }\n        // we need to add listItems.length to the index calculation here because the JavaScript modulos\n        // operator doesn't work with negative numbers\n        newCurrentIndex = (currentIndex - 1 + listItems.length) % listItems.length;\n        break;\n      }\n      case \"ArrowDown\": {\n        const currentItem = listItems[currentIndex];\n        if (currentItem && currentIndex >= 0) {\n          currentItem.classList.remove(\"active\");\n        }\n        newCurrentIndex = (currentIndex + 1) % listItems.length;\n        break;\n      }\n      case \"Tab\":\n      case \"Enter\":\n        if (autocomplete) {\n          autocomplete.classList.remove(\"open\");\n        }\n        break;\n      default:\n        break;\n    }\n\n    if (newCurrentIndex !== -1) {\n      const selectedItem = listItems[newCurrentIndex];\n      if (selectedItem) {\n        selectedItem.classList.add(\"active\");\n\n        if (!selectedItem.classList.contains(\"no-item-found\")) {\n          const qInput = document.getElementById(\"q\") as HTMLInputElement | null;\n          if (qInput) {\n            qInput.value = selectedItem.textContent ?? \"\";\n          }\n        }\n      }\n    }\n  });\n}"],"mappings":"wDAIA,IAAI,EAAmB,EACnB,EAAkB,EAEtB,MAAM,EAAe,MAAO,EAA0B,EAAe,IAAsC,CACzG,GAAI,CACF,IAAIA,EAEJ,AAGE,EAHE,EAAS,SAAW,MAChB,MAAM,EAAK,MAAO,qBAAqB,mBAAmB,MAE1D,MAAM,EAAK,OAAQ,kBAAmB,CAAE,KAAM,IAAI,gBAAgB,CAAE,EAAG,MAG/E,IAAM,EAAU,MAAM,EAAI,OAG1B,GAAI,GAAc,EAChB,OAGF,IAAM,EAAe,SAAS,cAA2B,iBACzD,GAAI,CAAC,EACH,OAGF,IAAM,EAAmB,SAAS,cAAgC,oBAClE,GAAI,CAAC,EACH,OAOF,GAJA,EAAa,UAAU,IAAI,QAC3B,EAAiB,kBAGb,IAAU,IAAI,SAAW,EAAG,CAC9B,IAAM,EAAqB,OAAO,OAAO,SAAS,cAAc,MAAO,CACrE,UAAW,gBACX,YAAa,EAAS,cAAc,eAAiB,qBAEvD,EAAiB,OAAO,GACxB,EAAkB,EAClB,OAGF,IAAM,EAAW,IAAI,iBAErB,IAAK,IAAM,KAAU,EAAQ,IAAM,GAAI,CACrC,IAAM,EAAK,OAAO,OAAO,SAAS,cAAc,MAAO,CAAE,YAAa,IAEtE,EAAO,YAAa,MAAU,CAC5B,EAAO,MAAQ,EAEf,IAAM,EAAO,SAAS,cAA+B,WACrD,GAAM,SAEN,EAAa,UAAU,OAAO,UAGhC,EAAS,OAAO,GAGlB,EAAiB,OAAO,GACxB,EAAkB,QACX,EAAO,CACd,QAAQ,MAAM,uCAAwC,KAIpD,EAAW,SAAS,eAAe,KAEzC,IAAIC,EAEA,GACF,EAAO,QAAS,MAAgB,CAC9B,aAAa,GAEb,IAAM,EAAQ,EAAS,MACjB,EAAY,EAAS,kBAAoB,EAE3C,EAAM,OAAS,IAEnB,EAAY,OAAO,WAAW,SAAY,CACxC,GAAI,IAAU,EAAS,MAAO,CAC5B,IAAM,EAAM,EAAE,EACd,MAAM,EAAa,EAAU,EAAO,KAErC,MAIP,MAAMC,EAAmC,SAAS,cAA2B,iBACvEC,EAA4C,SAAS,cAAgC,oBACvF,GAAoB,GACtB,EAAO,QAAS,EAAW,GAAyB,CAClD,IAAM,EAAY,CAAC,GAAG,EAAiB,UAEjC,EAAe,EAAU,UAAW,GAAS,EAAK,UAAU,SAAS,WACvE,EAAkB,GAEtB,OAAQ,EAAM,IAAd,CACE,IAAK,UAAW,CACd,IAAM,EAAc,EAAU,GAC1B,GAAe,GAAgB,GACjC,EAAY,UAAU,OAAO,UAI/B,GAAmB,EAAe,EAAI,EAAU,QAAU,EAAU,OACpE,MAEF,IAAK,YAAa,CAChB,IAAM,EAAc,EAAU,GAC1B,GAAe,GAAgB,GACjC,EAAY,UAAU,OAAO,UAE/B,GAAmB,EAAe,GAAK,EAAU,OACjD,MAEF,IAAK,MACL,IAAK,QACC,GACF,EAAa,UAAU,OAAO,QAEhC,MACF,QACE,MAGJ,GAAI,IAAoB,GAAI,CAC1B,IAAM,EAAe,EAAU,GAC/B,GAAI,IACF,EAAa,UAAU,IAAI,UAEvB,CAAC,EAAa,UAAU,SAAS,kBAAkB,CACrD,IAAM,EAAS,SAAS,eAAe,KACnC,IACF,EAAO,MAAQ,EAAa,aAAe"}